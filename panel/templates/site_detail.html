{% extends "base.html" %}
{% block content %}
{% set st = (site.status or '') %}
{% set st_class = 'ok' if st == 'running' else ('warn' if st in ['creating','pending'] else ('bad' if st == 'error' else 'ghost')) %}
{% set type_map = {'static':'静态', 'php':'PHP', 'reverse_proxy':'反向代理'} %}
{% set ns = namespace(cert_valid=false) %}
{% for c in certs %}
  {% if (c.status or '') == 'valid' %}
    {% set ns.cert_valid = true %}
  {% endif %}
{% endfor %}

<div class="page-head">
  <div class="page-title">
    <h1 class="h1">{{ site.name }}</h1>
    <div class="meta">
      <span class="meta-item">节点：{{ node.name if node else "-" }}</span>
      <span class="meta-item">类型：{{ type_map.get(site.type, site.type) }} · {{ site.web_server }}</span>
    </div>
    <div class="meta" style="margin-top:8px;flex-wrap:wrap;gap:8px;align-items:flex-start;">
      <span class="pill xs {{ st_class }}">{{ st or 'unknown' }}</span>
      <span class="meta-item">域名：<span class="mono" style="overflow-wrap:anywhere;">{{ (site.domains or [])|join(', ') }}</span></span>
    </div>
  </div>
  <div class="right">
    <a class="btn sm ghost" href="/websites">返回列表</a>
    <a class="btn sm" href="/websites/{{ site.id }}/edit">编辑</a>
    <details class="menu">
      <summary class="btn sm ghost">操作 ▾</summary>
      <div class="menu-pop">
        {% if site.type != 'reverse_proxy' and site.root_path %}
          <a class="menu-item" href="/websites/{{ site.id }}/files">文件管理</a>
        {% endif %}
        <a class="menu-item" href="/websites/{{ site.id }}/diagnose">诊断</a>

        <div class="menu-sep"></div>

        {% if ns.cert_valid %}
          <form method="post" action="/websites/{{ site.id }}/ssl/renew" style="margin:0;">
            <button class="menu-item" type="submit">续期 SSL</button>
          </form>
          <form method="post" action="/websites/{{ site.id }}/ssl/issue" style="margin:0;">
            <button class="menu-item" type="submit">重新申请 SSL</button>
          </form>
        {% else %}
          <form method="post" action="/websites/{{ site.id }}/ssl/issue" style="margin:0;">
            <button class="menu-item" type="submit">申请 SSL</button>
          </form>
          <form method="post" action="/websites/{{ site.id }}/ssl/renew" style="margin:0;">
            <button class="menu-item" type="submit">续期 SSL</button>
          </form>
        {% endif %}

        <div class="menu-sep"></div>
        <a class="menu-item danger" href="#danger">删除站点…</a>
      </div>
    </details>
  </div>
</div>

{% include "site_nav.html" %}

<div class="site-layout">
  <div class="site-stack">
    <div class="card compact">
      <div class="section-head">
        <div>
          <div class="section-title">站点概览</div>
          <div class="section-sub">核心配置与运行信息（更紧凑展示）。</div>
        </div>
        <span class="pill xs {{ st_class }}">{{ st or 'unknown' }}</span>
      </div>

      <div class="kv-lines">
        <div class="kvline"><div class="k">站点类型</div><div class="v">{{ type_map.get(site.type, site.type) }}</div></div>
        <div class="kvline"><div class="k">Web 服务器</div><div class="v">{{ site.web_server }}</div></div>
        <div class="kvline"><div class="k">根目录</div><div class="v mono" title="{{ site.root_path or '-' }}">{{ site.root_path or '-' }}</div></div>
        <div class="kvline"><div class="k">反向代理</div><div class="v mono" title="{{ site.proxy_target or '-' }}">{{ site.proxy_target or '-' }}</div></div>
        <div class="kvline"><div class="k">HTTPS 跳转</div><div class="v">{{ "启用" if site.https_redirect else "关闭" }}</div></div>
        <div class="kvline"><div class="k">Gzip</div><div class="v">{{ "启用" if (site.gzip_enabled is none or site.gzip_enabled) else "关闭" }}</div></div>
        <div class="kvline"><div class="k">自定义模板</div><div class="v">{{ "已配置" if site.nginx_tpl else "未配置" }}</div></div>
        <div class="kvline"><div class="k">创建时间</div><div class="v mono">{{ site.created_at }}</div></div>
      </div>
    </div>

    <div class="card compact">
      <div class="section-head">
        <div>
          <div class="section-title">健康状态</div>
          <div class="section-sub">实时监测与最近检查（异常会在此处聚合）。</div>
        </div>
      </div>

      {% set h = site.health_status or '' %}
      {% set hclass = 'ok' if h == 'ok' else ('bad' if h == 'fail' else 'ghost') %}
      <div class="kv-lines">
        <div class="kvline"><div class="k">当前状态</div><div class="v"><span class="pill xs {{ hclass }}">{{ h or 'unknown' }}</span></div></div>
        <div class="kvline"><div class="k">HTTP</div><div class="v mono">{{ site.health_code or '-' }}</div></div>
        <div class="kvline"><div class="k">延迟</div><div class="v mono">{{ site.health_latency_ms or 0 }} ms</div></div>
        <div class="kvline"><div class="k">最近检查</div><div class="v mono">{{ site.health_checked_at or '-' }}</div></div>
        <div class="kvline"><div class="k">错误</div><div class="v mono" title="{{ site.health_error or '' }}">{{ site.health_error or '-' }}</div></div>
      </div>

      {% if checks %}
        <details style="margin-top:10px;">
          <summary class="btn xs ghost">查看最近检查（{{ checks|length }}）</summary>
          <div class="table-wrap" style="margin-top:10px;">
            <table class="table no-sticky dense">
              <thead>
                <tr>
                  <th>时间</th>
                  <th>状态</th>
                  <th>HTTP</th>
                  <th>延迟</th>
                  <th>错误</th>
                </tr>
              </thead>
              <tbody>
                {% for c in checks %}
                {% set ok = (c.ok or 0) %}
                <tr>
                  <td class="mono">{{ c.checked_at }}</td>
                  <td><span class="pill xs {{ 'ok' if ok else 'bad' }}">{{ 'ok' if ok else 'fail' }}</span></td>
                  <td class="mono">{{ c.status_code or '-' }}</td>
                  <td class="mono">{{ c.latency_ms or 0 }} ms</td>
                  <td><div class="mono truncate" title="{{ c.error or '' }}">{{ c.error or '-' }}</div></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>
      {% endif %}
    </div>
  </div>

  <div class="site-stack">
    <div class="card compact" id="ssl">
      <div class="section-head">
        <div>
          <div class="section-title">SSL 证书</div>
          <div class="section-sub">状态与续期信息（申请/续期在右上角“操作”）。</div>
        </div>
      </div>
      {% if certs %}
      <div class="table-wrap" style="margin-top:10px;">
        <table class="table no-sticky dense">
          <thead>
            <tr>
              <th>域名</th>
              <th>状态</th>
              <th>有效期</th>
              <th>续期时间</th>
              <th>错误</th>
            </tr>
          </thead>
          <tbody>
            {% for c in certs %}
            {% set cst = (c.status or '') %}
            {% set cst_class = 'ok' if cst == 'valid' else ('warn' if cst in ['pending'] else ('bad' if cst in ['failed','expired'] else 'ghost')) %}
            <tr>
              <td class="mono">{{ c.domains_text }}</td>
              <td><span class="pill xs {{ cst_class }}">{{ cst or 'unknown' }}</span></td>
              <td class="mono">{{ c.not_before or '-' }} → {{ c.not_after or '-' }}</td>
              <td class="mono">{{ c.renew_at or '-' }}</td>
              <td><div class="mono truncate" title="{{ c.last_error or '' }}">{{ c.last_error or '-' }}</div></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="muted" style="margin-top:10px;">暂无证书（右上角“操作”里可申请 SSL）</div>
      {% endif %}
    </div>

    <div class="card compact">
      <div class="section-head">
        <div>
          <div class="section-title">变更历史</div>
          <div class="section-sub">创建/删除/证书等操作记录（默认显示最近）。</div>
        </div>
      </div>

      {% if events %}
        <div class="table-wrap" style="margin-top:10px;">
          <table class="table no-sticky dense">
            <thead>
              <tr>
                <th>时间</th>
                <th>动作</th>
                <th>状态</th>
                <th>操作者</th>
                <th>错误</th>
              </tr>
            </thead>
            <tbody>
              {% for e in events[:8] %}
              {% set es = (e.status or '') %}
              {% set ecls = 'ok' if es == 'success' else ('warn' if es == 'running' else ('bad' if es in ['failed','error'] else 'ghost')) %}
              <tr>
                <td class="mono">{{ e.created_at }}</td>
                <td>{{ e.action }}</td>
                <td><span class="pill xs {{ ecls }}">{{ es }}</span></td>
                <td>{{ e.actor or '-' }}</td>
                <td><div class="mono truncate" title="{{ e.error or '' }}">{{ e.error or '-' }}</div></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if events|length > 8 %}
          <details style="margin-top:10px;">
            <summary class="btn xs ghost">查看更多（{{ events|length }}）</summary>
            <div class="table-wrap" style="margin-top:10px;">
              <table class="table no-sticky dense">
                <thead>
                  <tr>
                    <th>时间</th>
                    <th>动作</th>
                    <th>状态</th>
                    <th>操作者</th>
                    <th>错误</th>
                  </tr>
                </thead>
                <tbody>
                  {% for e in events %}
                  {% set es = (e.status or '') %}
                  {% set ecls = 'ok' if es == 'success' else ('warn' if es == 'running' else ('bad' if es in ['failed','error'] else 'ghost')) %}
                  <tr>
                    <td class="mono">{{ e.created_at }}</td>
                    <td>{{ e.action }}</td>
                    <td><span class="pill xs {{ ecls }}">{{ es }}</span></td>
                    <td>{{ e.actor or '-' }}</td>
                    <td><div class="mono truncate" title="{{ e.error or '' }}">{{ e.error or '-' }}</div></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </details>
        {% endif %}
      {% else %}
        <div class="muted" style="margin-top:10px;">暂无变更记录</div>
      {% endif %}
    </div>
  </div>
</div>

<div class="card compact" id="danger" style="margin-top:12px;">
  <div class="section-head">
    <div>
      <div class="section-title">风险操作</div>
      <div class="section-sub">删除站点会移除面板记录，可选清理节点文件与证书。</div>
    </div>
  </div>
  <form method="post" action="/websites/{{ site.id }}/delete" class="form" onsubmit="return confirm('确定删除该站点吗？');">
    <label class="help"><input type="checkbox" name="delete_files" style="transform:translateY(1px);"> 删除站点目录数据</label>
    <label class="help"><input type="checkbox" name="delete_cert" style="transform:translateY(1px);"> 删除证书文件</label>
    <button class="btn sm danger" type="submit" style="margin-top:8px;">删除站点</button>
  </form>
</div>
{% endblock %}
