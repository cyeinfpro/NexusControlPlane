{% extends "base.html" %}

{% block content %}
{% set t = (site.type or 'static')|lower %}
{% set stt = (site.status or '')|lower %}
{% set latest = (certs[0] if certs else None) %}
{% set ssl = ((latest.status or 'none')|lower if latest else 'none') %}
{% set primary = (site.domains[0] if site.domains else '') %}

<div class="page-head">
  <div class="page-title">
    <h1 class="h1">{{ site.name }}</h1>
    <div class="meta" style="flex-wrap:wrap;">
      <span class="meta-item">节点：<strong>{{ node.name if node else '-' }}</strong></span>
      <span class="meta-item">主域名：<span class="mono">{{ primary or '-' }}</span></span>
      <span class="meta-item">域名：<span class="mono" style="word-break:break-all;">{{ (site.domains or [])|join(', ') }}</span></span>
    </div>
  </div>
  <div class="right">
    {% if site.root_path %}
      <a class="btn sm ghost" href="/websites/{{ site.id }}/files">文件管理</a>
    {% endif %}
    {% if primary %}
      <a class="btn sm ghost" href="https://{{ primary }}" target="_blank" rel="noreferrer">打开网站 ↗</a>
    {% endif %}
    <details class="menu">
      <summary class="btn sm secondary">SSL ▾</summary>
      <div class="menu-pop">
        <form method="post" action="/websites/{{ site.id }}/ssl/issue" onsubmit="return confirm('将尝试申请/重签证书，并自动写入 Nginx 配置。继续吗？');">
          <button class="menu-item" type="submit">申请/重签证书</button>
        </form>
        <form method="post" action="/websites/{{ site.id }}/ssl/renew" onsubmit="return confirm('将尝试续期证书，并更新 Nginx 配置。继续吗？');">
          <button class="menu-item" type="submit">续期证书</button>
        </form>
      </div>
    </details>
    <a class="btn sm ghost" href="/websites">返回</a>
  </div>
</div>

<div class="au-stats" style="margin: 6px 0 10px 0;">
  {% if t == 'php' %}
    <span class="pill-stat warn">类型 <strong>PHP</strong></span>
  {% elif t == 'reverse_proxy' %}
    <span class="pill-stat info">类型 <strong>反代</strong></span>
  {% else %}
    <span class="pill-stat info">类型 <strong>静态</strong></span>
  {% endif %}

  {% if stt == 'running' %}
    <span class="pill-stat ok">状态 <strong>运行中</strong></span>
  {% elif stt == 'creating' %}
    <span class="pill-stat warn">状态 <strong>创建中</strong></span>
  {% elif stt == 'error' %}
    <span class="pill-stat bad">状态 <strong>异常</strong></span>
  {% else %}
    <span class="pill-stat muted">状态 <strong>{{ site.status or '-' }}</strong></span>
  {% endif %}

  {% if ssl == 'valid' %}
    <span class="pill-stat ok">SSL <strong>有效</strong></span>
  {% elif ssl == 'pending' %}
    <span class="pill-stat warn">SSL <strong>待处理</strong></span>
  {% elif ssl == 'failed' %}
    <span class="pill-stat bad">SSL <strong>失败</strong></span>
  {% else %}
    <span class="pill-stat muted">SSL <strong>无</strong></span>
  {% endif %}

  {% if latest and latest.not_after %}
    <span class="pill-stat muted" title="证书到期时间">到期 <strong class="mono">{{ latest.not_after }}</strong></span>
  {% endif %}
</div>

<div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 12px;">
  {# =====================
     Overview
     ===================== #}
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">站点配置</div>
        <div class="card-sub">面板记录与下发参数（Nginx 配置由 Agent 负责落地）。</div>
      </div>
    </div>

    <div class="table-wrap">
      <table class="table">
        <tbody>
          <tr><th>节点</th><td>{{ node.name if node else '-' }}</td></tr>
          <tr><th>Agent</th><td class="mono" style="word-break:break-all;">{{ node.base_url if node else '-' }}</td></tr>
          <tr><th>站点类型</th><td>{{ site.type }}</td></tr>
          <tr><th>Web 服务器</th><td>{{ site.web_server }}</td></tr>
          <tr><th>根目录</th><td class="mono" style="word-break:break-all;">{{ site.root_path or '-' }}</td></tr>
          <tr><th>反向代理目标</th><td class="mono" style="word-break:break-all;">{{ site.proxy_target or '-' }}</td></tr>
          <tr><th>HTTPS 跳转</th><td>{{ "启用" if site.https_redirect else "关闭" }}</td></tr>
          <tr><th>Gzip</th><td>{{ "启用" if site.gzip_enabled else "关闭" }}</td></tr>
          <tr><th>自定义模板</th><td>{{ "已配置" if site.nginx_tpl else "未配置" }}</td></tr>
          <tr><th>创建时间</th><td class="mono">{{ site.created_at }}</td></tr>
          <tr><th>更新时间</th><td class="mono">{{ site.updated_at }}</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  {# =====================
     SSL
     ===================== #}
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">SSL 证书</div>
        <div class="card-sub">申请/续期使用 HTTP-01（需外网可访问 80 端口）。</div>
      </div>
    </div>

    {% if certs %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>域名</th>
              <th>状态</th>
              <th>有效期</th>
              <th>续期时间</th>
              <th>错误</th>
            </tr>
          </thead>
          <tbody>
            {% for c in certs %}
              {% set cs = (c.status or '')|lower %}
              <tr>
                <td class="mono" style="word-break:break-all;">{{ c.domains_text }}</td>
                <td>
                  {% if cs == 'valid' %}
                    <span class="badge ok">有效</span>
                  {% elif cs == 'pending' %}
                    <span class="badge warn">待处理</span>
                  {% elif cs == 'failed' %}
                    <span class="badge bad">失败</span>
                  {% else %}
                    <span class="badge muted">{{ c.status }}</span>
                  {% endif %}
                </td>
                <td class="mono">{{ c.not_before or "-" }} → {{ c.not_after or "-" }}</td>
                <td class="mono">{{ c.renew_at or "-" }}</td>
                <td class="mono" style="max-width:260px;word-break:break-word;">{{ c.last_error or "-" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="muted">暂无证书记录。可点击右上角「SSL」按钮申请。</div>
    {% endif %}
  </div>

  {# =====================
     Tasks
     ===================== #}
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">最近任务</div>
        <div class="card-sub">创建/证书/删除等操作会写入任务，失败时请先看错误信息。</div>
      </div>
    </div>

    {% if tasks %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>时间</th>
              <th>类型</th>
              <th>状态</th>
              <th>进度</th>
              <th>错误</th>
            </tr>
          </thead>
          <tbody>
            {% for tk in tasks %}
              {% set ts = (tk.status or '')|lower %}
              <tr>
                <td class="mono">{{ tk.created_at }}</td>
                <td class="mono">{{ tk.type }}</td>
                <td>
                  {% if ts == 'success' %}
                    <span class="badge ok">成功</span>
                  {% elif ts == 'running' %}
                    <span class="badge warn">运行中</span>
                  {% elif ts == 'failed' %}
                    <span class="badge bad">失败</span>
                  {% else %}
                    <span class="badge muted">{{ tk.status or '-' }}</span>
                  {% endif %}
                </td>
                <td class="mono">{{ tk.progress or 0 }}%</td>
                <td class="mono" style="max-width:320px;word-break:break-word;">{{ tk.error or '-' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="muted">暂无任务记录。</div>
    {% endif %}
  </div>

  {# =====================
     Danger zone
     ===================== #}
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">危险操作</div>
        <div class="card-sub">删除后站点记录会从面板移除；可选清理节点上的文件与证书。</div>
      </div>
    </div>

    <form method="post" action="/websites/{{ site.id }}/delete" class="form" onsubmit="return confirm('确定删除该站点吗？');">
      <div class="row" style="gap:14px; align-items:center; flex-wrap:wrap;">
        <label class="help"><input type="checkbox" name="delete_files" style="transform:translateY(1px);"> 删除站点目录数据</label>
        <label class="help"><input type="checkbox" name="delete_cert" style="transform:translateY(1px);"> 删除证书文件</label>
      </div>
      <div class="help compact">建议：若只是临时下线，请先在节点侧停用/改配置；确认无误再删除。</div>
      <button class="btn sm" type="submit" style="margin-top:10px;">删除站点</button>
    </form>
  </div>
</div>
{% endblock %}
