{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col">
    <h1 class="h1">{{ node.name or node.display_ip }}</h1>
    <div class="muted">IP：{{ node.display_ip or "-" }}{% if node.agent_version %} · {{ node.agent_version }}{% endif %}</div>
    <div class="muted">上报：{{ node.last_seen_at or "-" }}</div>
  </div>
  <div class="col right">
    <a class="btn ghost" href="/">返回控制台</a>
    <form method="post" action="/nodes/{{ node.id }}/delete" style="margin:0;">
      <button class="btn danger" type="submit" onclick="return confirm('确认移除该节点？')">移除节点</button>
    </form>
  </div>
</div>

<div class="card" style="margin-top:16px;">
  <div class="row">
    <div class="col">
      <h2 class="h2">一键操作</h2>
      <p class="muted">需要时查看接入或卸载命令</p>
    </div>
    <div class="col right">
      <div class="row" style="gap:10px;justify-content:flex-end;">
<button class="btn ghost" type="button" id="installCmdBtn" onclick="openCommandModal('一键接入命令', window.__INSTALL_CMD__)">查看接入命令</button>
        <button class="btn ghost" type="button" id="uninstallCmdBtn" onclick="openCommandModal('一键卸载 Agent', window.__UNINSTALL_CMD__)">查看卸载命令</button>
      </div>
    </div>
  </div>
</div>

<section>
  <div class="card">
    <div class="row">
      <div class="col">
        <h2 class="h2">规则与流量统计</h2>
        <p class="muted">编辑 listen / remote / wss 参数，支持启用/暂停，并展示活跃/累计与总流量</p>
      </div>
      <div class="col right">
        <div class="row" style="gap:10px;justify-content:flex-end;flex-wrap:wrap;">
          <a class="btn ghost" href="/api/nodes/{{ node.id }}/backup">备份规则</a>
          <button class="btn ghost" type="button" id="restoreRulesBtn" onclick="triggerRestore()">恢复规则</button>
          <button class="btn" onclick="newRule()">新增规则</button>
<button class="btn ghost" id="autoRefreshBtn" onclick="toggleAutoRefresh()">自动刷新：开</button>
        </div>
      </div>
    </div>
    <div id="rulesLoading" class="muted">正在加载规则…</div>
    <!-- Mobile: card list (table is desktop only) -->
    <div id="rulesMobile" class="rules-mobile" style="display:none;"></div>
    <div class="table-wrap">
      <table id="rulesTable" class="table rules-table" style="display:none;">
        <thead>
          <tr>
            <th>#</th>
            <th>状态</th>
            <th class="listen">Listen</th>
            <th class="health">连通检测</th>
            <th class="stat">活跃/累计</th>
            <th class="stat">总流量</th>
            <th class="actions">操作</th>
          </tr>
        </thead>
        <tbody id="rulesBody"></tbody>
      </table>
    </div>
    <div id="statsLoading" class="muted">正在加载流量统计…</div>
  </div>
</section>

<!-- Edit Modal -->
<div id="modal" class="modal" style="display:none;">
  <div class="modal-inner">
    <div class="row">
      <div class="col"><div class="h2" id="modalTitle">编辑规则</div></div>
      <div class="col right"><button class="btn ghost" onclick="closeModal()">关闭</button></div>
    </div>
    <div class="form">
      <div class="row" style="gap:12px;">
        <div class="col">
          <label class="label">Listen (例如 0.0.0.0:443)</label>
          <input class="input" id="f_listen" placeholder="0.0.0.0:443">
        </div>
        <div class="col">
          <label class="label">状态</label>
          <select class="select" id="f_disabled">
            <option value="0">启用</option>
            <option value="1">暂停</option>
          </select>
        </div>
      </div>

      <label class="label">Remote 目标（每行一个 host:port）</label>
      <textarea class="textarea" id="f_remotes" rows="5" placeholder="203.0.113.10:443\n198.51.100.8:443"></textarea>

      <div class="row" style="gap:12px;">
        <div class="col">
          <label class="label">策略</label>
          <select class="select" id="f_balance">
            <option value="roundrobin">轮询</option>
            <option value="iphash">IP Hash</option>
          </select>
        </div>
        <div class="col">
          <label class="label">权重（与 Remote 行数一致，逗号分隔，可空）</label>
          <input class="input" id="f_weights" placeholder="1,1,2">
        </div>
        <div class="col">
          <label class="label">协议</label>
          <select class="select" id="f_protocol">
            <option value="tcp">TCP</option>
            <option value="udp">UDP</option>
            <option value="tcp+udp">TCP+UDP</option>
          </select>
        </div>
      </div>

      <label class="label">隧道模式</label>
      <select class="select" id="f_type">
        <option value="tcp">TCP/UDP</option>
        <option value="wss_send">WSS 隧道（自动配对）</option>
        <option value="wss_recv">WSS 接收端（手动）</option>
      </select>

      <div id="wssBox" style="display:none;">
<div id="wssBox" style="display:none;">
        <input type="hidden" id="f_wss_link_id" value="">

        <div id="wssAutoRow" class="row" style="gap:12px;align-items:flex-end; display:none;">
          <div class="col">
            <label class="label">接收机</label>
            <select id="f_wss_receiver" class="select">
              <option value="">请选择接收机</option>
              {% for n in all_nodes %}
                {% if n.id != node.id %}
                  <option value="{{n.id}}">{{n.name}} · {{n.display_ip}}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div style="width:160px;">
            <label class="label">接收端口</label>
            <input class="input" id="f_wss_receiver_port" type="number" value="443" min="1" max="65535"/>
          </div>
        </div>

        <div id="pairingRow" class="row" style="gap:12px;align-items:center; display:none;">
          <div class="col">
            <label class="label">配对码（手动接收端使用）</label>
            <textarea class="textarea" id="f_pairing" rows="2" placeholder='{"host":"www.bing.com","path":"/ws","sni":"www.microsoft.com","tls":true,"insecure":true}'></textarea>
          </div>
          <div style="width:140px;">
            <label class="label">&nbsp;</label>
            <button class="btn ghost" type="button" onclick="applyPairingCode()">应用</button>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label class="label">WSS Host</label>
            <input class="input" id="f_wss_host" placeholder="www.bing.com"/>
          </div>
          <div>
            <label class="label">WSS Path</label>
            <input class="input" id="f_wss_path" placeholder="/ws"/>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label class="label">TLS SNI</label>
            <input class="input" id="f_wss_sni" placeholder="www.microsoft.com"/>
          </div>
          <div class="grid2">
            <div>
              <label class="label">TLS</label>
              <select class="select" id="f_wss_tls">
                <option value="1">启用</option>
                <option value="0">关闭</option>
              </select>
            </div>
            <div>
              <label class="label">Insecure</label>
              <select class="select" id="f_wss_insecure">
                <option value="0">否</option>
                <option value="1">是</option>
              </select>
            </div>
          </div>
        </div>

        <div class="help muted" style="margin-top:8px;">
          自动配对：选择接收机后，保存规则会自动在接收机生成对应接收规则，并保持同步（只读）。<br/>
          手动接收：仅当你需要手工创建接收端规则时，粘贴配对码并点击“应用”。
        </div>
      </div>

      <div class="row" style="gap:12px; justify-content:flex-end;">
        <button class="btn ghost" onclick="closeModal()">取消</button>
        <button class="btn" onclick="saveRule()">保存</button>
      </div>

      <div id="modalMsg" class="form-error" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<div id="restoreModal" class="modal" style="display:none;">
  <div class="modal-inner" style="max-width:860px;">
    <div class="row">
      <div class="col"><div class="h2">恢复规则</div></div>
      <div class="col right"><button class="btn ghost" type="button" onclick="closeRestoreModal()">关闭</button></div>
    </div>
    <div class="form">
      <label class="label">粘贴备份文件内容（JSON）</label>
      <textarea class="textarea" id="restoreText" rows="14" placeholder='{\n  "ok": true,\n  "pool": {\n    "endpoints": []\n  }\n}'></textarea>
      <div class="row" style="gap:12px;justify-content:flex-end;margin-top:12px;">
        <button class="btn ghost" type="button" onclick="closeRestoreModal()">取消</button>
        <button class="btn" type="button" onclick="restoreFromText()">开始恢复</button>
      </div>
    </div>
  </div>
</div>
<div id="pairingModal" class="modal" style="display:none;">
  <div class="modal-inner">
    <div class="row">
      <div class="col"><div class="h2">WSS 配对码</div></div>
      <div class="col right"><button class="btn ghost" onclick="closePairingModal()">关闭</button></div>
    </div>
    <p class="muted">将此配对码粘贴到另一端的 WSS 接收端，可自动填充参数。</p>
    <pre class="code-block" id="pairingCodeText"></pre>
    <div class="row" style="justify-content:flex-end;">
      <button class="btn" data-copy-target="pairingCodeText">复制配对码</button>
    </div>
  </div>
</div>

<div id="commandModal" class="modal" style="display:none;">
  <div class="modal-inner">
    <div class="row">
      <div class="col"><div class="h2" id="commandTitle">命令</div></div>
      <div class="col right"><button class="btn ghost" onclick="closeCommandModal()">关闭</button></div>
    </div>
    <p class="muted">复制命令到目标节点执行。</p>
    <pre class="code-block" id="commandText"></pre>
    <div class="row" style="justify-content:flex-end;">
      <button class="btn" data-copy-target="commandText">复制命令</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/app.js"></script>
<script>
window.__NODE_ID__ = {{ node.id }};
window.__NODE_IP__ = {{ (node.display_ip or node.name)|tojson }};
window.__INSTALL_CMD__ = {{ install_cmd|tojson }};
window.__UNINSTALL_CMD__ = {{ uninstall_cmd|tojson }};
window.addEventListener('DOMContentLoaded', () => {
  initNodePage();
});
document.querySelectorAll('[data-copy-target]').forEach((btn)=>{
  btn.addEventListener('click', async ()=>{
    const id = btn.getAttribute('data-copy-target');
    const text = document.getElementById(id).textContent.trim();
    try{
      await navigator.clipboard.writeText(text);
      btn.textContent = '已复制';
      setTimeout(()=>{ btn.textContent = '复制命令'; }, 1200);
    }catch(e){
      alert('复制失败，请手动复制');
    }
  });
});
{% if show_install_cmd %}
openCommandModal('一键接入命令', window.__INSTALL_CMD__);
{% endif %}
</script>
{% endblock %}
