{% extends "base.html" %}

{% block content %}
<div class="page-head">
  <div class="page-title">
    <h1 class="h1">新建站点</h1>
    <div class="meta">
      <span class="meta-item">选择网站节点并填写域名，面板会自动确保环境并下发 Nginx 配置。</span>
    </div>
  </div>
  <div class="right">
    <a class="btn sm ghost" href="/websites">返回列表</a>
  </div>
</div>

{% if not nodes %}
  <div class="flash" style="background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.4);">
    暂无网站机节点。请先在“节点管理”中新增节点并将角色设置为“网站机”。
  </div>
{% endif %}

<div class="card" style="max-width:980px;margin:0 auto;">
  <form method="post" action="/websites/new" class="form" id="siteCreateForm">
    <div class="form-section">
      <div class="section-head">
        <div>
          <div class="section-title">基础信息</div>
          <div class="muted sm">首个域名将作为主域名（用于配置文件命名与证书目录）。</div>
        </div>
      </div>

      <div class="row" style="gap:12px;align-items:flex-start;flex-wrap:wrap;">
        <div class="col" style="min-width:320px;flex:1;">
          <label class="label">网站机节点</label>
          <select class="select" name="node_id" id="nodeSelect" required {% if not nodes %}disabled{% endif %}>
            {% for n in nodes %}
              <option value="{{ n.id }}" data-root-base="{{ n.website_root_base or '/www' }}">{{ n.name }} · {{ n.base_url }}</option>
            {% endfor %}
          </select>
          <div class="help compact">建议为不同业务选择不同节点/分组，便于权限与容量隔离。</div>
        </div>

        <div class="col" style="min-width:220px;flex:0.6;">
          <label class="label">站点类型</label>
          <select class="select" name="site_type" id="typeSelect">
            <option value="static">静态站点</option>
            <option value="php">PHP 站点</option>
            <option value="reverse_proxy">反向代理</option>
          </select>
          <div class="help compact">PHP / 反代会自动安装/检查所需组件。</div>
        </div>

        <div class="col" style="min-width:180px;flex:0.4;">
          <label class="label">Web 服务器</label>
          <select class="select" name="web_server" disabled>
            <option value="nginx" selected>nginx</option>
          </select>
          <div class="help compact">当前仅支持 Nginx（Agent 侧自动配置）。</div>
        </div>
      </div>

      <div class="row" style="gap:12px;align-items:flex-start;flex-wrap:wrap;">
        <div class="col" style="min-width:260px;flex:1;">
          <label class="label">站点名称（可选）</label>
          <input class="input" name="name" id="siteName" placeholder="例如：官网 / 客户A / 落地页" />
          <div class="help compact">留空时将默认使用主域名作为名称。</div>
        </div>
        <div class="col" style="min-width:360px;flex:2;">
          <label class="label">域名（支持多个）</label>
          <input class="input" name="domains" id="domainsInput" placeholder="example.com, www.example.com" required {% if not nodes %}disabled{% endif %} />
          <div class="help compact">多个域名可用逗号/空格/换行分隔。申请证书需确保域名解析到该节点并开放 80 端口（HTTP-01）。</div>
        </div>
      </div>
    </div>

    <div class="form-section" id="rootSection">
      <div class="section-head">
        <div>
          <div class="section-title">站点目录</div>
          <div class="muted sm">静态 / PHP 站点需要根目录；反向代理不需要。</div>
        </div>
        <button class="btn xs ghost" type="button" id="genRootBtn">根据域名生成</button>
      </div>
      <label class="label">根目录</label>
      <input class="input" name="root_path" id="rootPath" placeholder="例如：/www/wwwroot/example.com" {% if not nodes %}disabled{% endif %} />
      <div class="help compact">建议保持在节点的“网站根目录”下（默认 <span class="mono">/www</span>）。</div>
    </div>

    <div class="form-section" id="proxySection" style="display:none;">
      <div class="section-head">
        <div>
          <div class="section-title">反向代理</div>
          <div class="muted sm">将域名转发到后端服务（HTTP）。</div>
        </div>
      </div>
      <label class="label">代理目标</label>
      <input class="input" name="proxy_target" id="proxyTarget" placeholder="http://127.0.0.1:8080" {% if not nodes %}disabled{% endif %} />
      <div class="help compact">可填写 <span class="mono">127.0.0.1:8080</span>（会自动补 <span class="mono">http://</span>）。如需 HTTPS 后端，请填写完整 URL。</div>
    </div>

    <div class="form-section">
      <div class="section-head">
        <div>
          <div class="section-title">行为开关</div>
          <div class="muted sm">证书就绪后跳转、压缩等。</div>
        </div>
      </div>
      <div class="row" style="gap:14px;align-items:center;flex-wrap:wrap;">
        <label class="help"><input type="checkbox" name="https_redirect" style="transform:translateY(1px);" /> 证书就绪后强制 HTTPS</label>
        <label class="help"><input type="checkbox" name="gzip_enabled" checked style="transform:translateY(1px);" /> 启用 Gzip</label>
      </div>
    </div>

    <details class="card compact" style="margin-top:10px;">
      <summary class="row between" style="cursor:pointer;">
        <span style="font-weight:900;">高级：自定义 Nginx 模板（可选）</span>
        <span class="muted sm">展开/收起</span>
      </summary>
      <div style="margin-top:10px;">
        <label class="label">自定义模板</label>
        <textarea class="textarea" name="nginx_tpl" rows="10" placeholder="支持变量：SERVER_NAME, ROOT_PATH, PROXY_TARGET, SSL_CERT, SSL_KEY, GZIP_CONF" {% if not nodes %}disabled{% endif %}></textarea>
        <div class="help compact">留空则使用内置模板。自定义模板需自行处理 80/443、SSL、反代等配置。</div>
      </div>
    </details>

    <div class="row between" style="margin-top:14px;">
      <a class="btn ghost" href="/websites">取消</a>
      <button class="btn secondary" type="submit" {% if not nodes %}disabled{% endif %}>创建站点</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const nodeSel = document.getElementById('nodeSelect');
    const typeSel = document.getElementById('typeSelect');
    const domains = document.getElementById('domainsInput');
    const nameInput = document.getElementById('siteName');
    const rootSection = document.getElementById('rootSection');
    const proxySection = document.getElementById('proxySection');
    const rootPath = document.getElementById('rootPath');
    const genRootBtn = document.getElementById('genRootBtn');

    if(!nodeSel || !typeSel || !domains || !rootSection || !proxySection) return;

    function firstDomain(){
      const raw = (domains.value || '').replace(/;/g, ',').replace(/\n/g, ',');
      const parts = raw.split(',').map(x => x.trim()).filter(Boolean);
      const out = [];
      parts.forEach(p => {
        p.split(/\s+/).map(x => x.trim()).filter(Boolean).forEach(x => out.push(x));
      });
      if(!out.length) return '';
      return String(out[0]).trim().toLowerCase().replace(/^\.+/, '').replace(/\.+$/, '');
    }

    function rootBase(){
      const opt = nodeSel.options[nodeSel.selectedIndex];
      const b = opt ? (opt.dataset.rootBase || '') : '';
      return (b || '/www').replace(/\/+$/, '');
    }

    function genRoot(){
      const d = firstDomain();
      if(!d) return;
      rootPath.value = `${rootBase()}/wwwroot/${d}`;
    }

    function toggleByType(){
      const t = typeSel.value;
      if(t === 'reverse_proxy'){
        proxySection.style.display = '';
        rootSection.style.display = 'none';
      } else {
        proxySection.style.display = 'none';
        rootSection.style.display = '';
      }
    }

    genRootBtn?.addEventListener('click', genRoot);
    typeSel.addEventListener('change', () => {
      toggleByType();
      if(typeSel.value !== 'reverse_proxy' && !(rootPath.value || '').trim()){
        genRoot();
      }
    });

    domains.addEventListener('blur', () => {
      const d = firstDomain();
      if(d && !(nameInput.value || '').trim()){
        nameInput.value = d;
      }
      if(typeSel.value !== 'reverse_proxy' && !(rootPath.value || '').trim()){
        genRoot();
      }
    });

    nodeSel.addEventListener('change', () => {
      if(typeSel.value !== 'reverse_proxy' && !(rootPath.value || '').trim()){
        genRoot();
      }
    });

    // initial
    toggleByType();
  })();
</script>
{% endblock %}
