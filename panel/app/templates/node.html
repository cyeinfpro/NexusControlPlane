{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="row between">
    <div>
      <div class="card-title">节点：{{ node.name }}</div>
      <div class="muted small">{{ node.base_url }}</div>
    </div>
    <form method="post" action="/api/nodes/{{ node.id }}/delete" onsubmit="return confirm('确认删除此节点？');">
      <button class="btn danger" type="submit">删除节点</button>
    </form>
  </div>

  <div class="divider"></div>
  <div class="row gap">
    <button class="btn" onclick="panel.refreshNode({{ node.id }})">刷新状态</button>
    <button class="btn" onclick="panel.apply({{ node.id }})">应用配置 (重启Realm)</button>
    <button class="btn" onclick="panel.showAddRule()">添加规则</button>
    <button class="btn" onclick="panel.showLogs({{ node.id }})">查看日志</button>
  </div>

  <div id="node-status" class="status-grid"></div>

  <div class="divider"></div>
  <div class="card-title">规则列表</div>
  <div id="rules" class="list"></div>
</div>

<!-- Add Rule Modal -->
<div id="modal" class="modal hidden">
  <div class="modal-card">
    <div class="row between">
      <div class="card-title">添加规则</div>
      <button class="btn ghost" onclick="panel.hideModal()">关闭</button>
    </div>
    <form id="rule-form">
      <div class="grid two">
        <div>
          <label>本地端口</label>
          <input name="local_port" type="number" placeholder="443" required />
        </div>
        <div>
          <label>协议</label>
          <select name="protocol">
            <option value="tcp+udp">TCP/UDP</option>
            <option value="tcp">TCP</option>
            <option value="udp">UDP</option>
          </select>
        </div>
        <div>
          <label>模式</label>
          <select name="mode" onchange="panel.onModeChange(this.value)">
            <option value="tcp_udp">TCP/UDP 转发</option>
            <option value="wss_send">WSS 发送端</option>
            <option value="wss_recv">WSS 接收端</option>
          </select>
        </div>
        <div>
          <label>负载均衡</label>
          <select name="algo">
            <option value="round_robin">轮询 (round_robin)</option>
            <option value="ip_hash">IP Hash (ip_hash)</option>
          </select>
        </div>
      </div>

      <label>目标地址（可多行）</label>
      <textarea name="targets_text" placeholder="198.176.54.226:443\n156.248.11.133:443"></textarea>

      <div id="wss-box" class="hidden">
        <div class="divider"></div>
        <div class="card-title">WSS 参数</div>
        <div class="muted small">接收端创建后会生成配对码；发送端可粘贴配对码自动填充 Host/Path/SNI。</div>

        <div class="grid two">
          <div>
            <label>配对码（仅发送端可填）</label>
            <input name="pair_code" placeholder="如：p8A9k2Qe1Z" />
          </div>
          <div>
            <label>Host</label>
            <input name="wss_host" placeholder="www.bing.com" />
          </div>
          <div>
            <label>Path</label>
            <input name="wss_path" placeholder="/ws" />
          </div>
          <div>
            <label>SNI</label>
            <input name="wss_sni" placeholder="www.bing.com" />
          </div>
        </div>

        <label class="checkbox">
          <input name="wss_insecure" type="checkbox" value="1" />
          <span>insecure（忽略证书校验）</span>
        </label>

        <div id="wss-recv-extra" class="hidden">
          <div class="grid two">
            <div>
              <label>证书 fullchain.pem</label>
              <input name="wss_cert" placeholder="/etc/realm-agent/certs/fullchain.pem" />
            </div>
            <div>
              <label>证书 privkey.pem</label>
              <input name="wss_key" placeholder="/etc/realm-agent/certs/privkey.pem" />
            </div>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <button class="btn primary" type="submit">创建规则</button>
    </form>
  </div>
</div>

<!-- Logs Modal -->
<div id="logmodal" class="modal hidden">
  <div class="modal-card large">
    <div class="row between">
      <div class="card-title">Realm 日志</div>
      <button class="btn ghost" onclick="panel.hideLogs()">关闭</button>
    </div>
    <pre id="logs" class="pre"></pre>
  </div>
</div>

<script>
  window.PAGE = { type: "node", nodeId: {{ node.id }} };
</script>
{% endblock %}
